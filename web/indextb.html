<!DOCTYPE html>
<html>

<head>
    <title>Live Vehicle Data Map</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Add references to the Azure Maps Map control JavaScript and CSS files. -->
    <link rel="stylesheet" href="https://atlas.microsoft.com/sdk/javascript/mapcontrol/2/atlas.min.css" type="text/css">
    <script src="https://atlas.microsoft.com/sdk/javascript/mapcontrol/2/atlas.min.js"></script>

    <!-- Add a reference to the Azure Maps Services Module JavaScript file. -->
    <script src="https://atlas.microsoft.com/sdk/javascript/mapcontrol/2/atlas-service.min.js"></script>
    <!-- Animations -->
    <script src="./js/azure-maps-animations.min.js"></script>
    <!-- Promise based http client. https://github.com/axios/axios -->
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <!-- SignalR -->
    <script src="https://unpkg.com/@aspnet/signalr@1.0.2/dist/browser/signalr.js"></script>

    <script>
        console.log('Start JS');
        // const baseurl = 'http://localhost:7071';
        const baseurl = 'https://realtimevehicletracking.azurewebsites.net';
        var map, tileLayer;
        var weatherTileUrl = 'https://{azMapsDomain}/map/tile?api-version=2.0&tilesetId={layerName}&zoom={z}&x={x}&y={y}';

        
        function GetMap() {
            //Instantiate a map object
            map = new atlas.Map("myMap", {
                //Add your Azure Maps subscription key to the map SDK. Get an Azure Maps key at https://azure.com/maps
                authOptions: {
                    authType: 'subscriptionKey',
                    subscriptionKey: 'MaRAsIot1DzMQItYmcsfgSQs9scqKQlzqnWAffMaqM8'
                },
                style: "satellite",
                zoom: 14.5,
                center: [-122.286137, 52.520000],
                view: 'Auto',
            });

            //Wait until the map resources are ready.
            console.log('Map Ready');

            map.events.add('ready', function () {

                //Initialize the vehicle icon layers
                map.imageSprite.add('dozer-icon', 'https://realtimevehicletracking.azurewebsites.net/images/dozer.png');
                map.imageSprite.add('shovel-icon', 'https://realtimevehicletracking.azurewebsites.net/images/dozer.png');
                map.imageSprite.add('truck-icon', 'https://realtimevehicletracking.azurewebsites.net/images/dozer.png');

                //Create the vehicle data source and add it to the map
                datasource = new atlas.source.DataSource();
                map.sources.add(datasource);                
                console.log('Map Ready inside 2');
                GetConnectionInfo().then(function (info) {
                    console.log('GetConnectionInfo Start');
                    let accessToken = info.accessToken
                    const options = {
                        accessTokenFactory: function () {
                            if (accessToken) {
                                const _accessToken = accessToken
                                accessToken = null
                                return _accessToken
                            } else {
                                return GetConnectionInfo().then(function (info) {
                                    return info.accessToken
                                })
                            }
                        }
                    }

                    const connection = new signalR.HubConnectionBuilder()
                        .withUrl(info.url, options)
                        .build()
                    console.log('Start Connection');
                    StartConnection(connection)

                    // Establish the connection
                    console.log('Establish Connection');
                    connection.on('newDiggerData', ProcessVehicleData)

                    connection.onclose(function () {
                        console.log('disconnected')
                        setTimeout(function () { StartConnection(connection) }, 5000)
                    })
                }).catch(console.error)


            });
        }

        let datasource;
        let vehicles = [];

        function ProcessVehicleData(flight) {
            var vehicleJson = JSON.parse(flight)

            if (datasource.shapesMap.has(vehicleJson.EquipmentID))
            {
                var coords = [ parseFloat(vehicleJson.Longtitude), parseFloat(vehicleJson.Latitude) ]
                console.log('prposed-coords', vehicleJson.EquipmentID, coords)
                atlas.animations.setCoordinates(vehicles[vehicleJson.EquipmentID], coords, { duration: 3000, autoPlay: true });

            } else {
                // console.log("its not here")
                var newVehiclePin = new atlas.Shape(new atlas.data.Point([vehicleJson.Longtitude, vehicleJson.Latitude]), vehicleJson.EquipmentID);
                newVehiclePin.addProperty('vehicletype', vehicleJson.VehicleType);
                    // check vechicleJson value of vehicle and attach a shape property to represent the shape image
                    if (vehicleJson.VehicleType == 'Shovel') {newVehiclePin.addProperty('image', "shovel-icon");}
                    else if (vehicleJson.VehicleType == 'Dozer') {newVehiclePin.addProperty('image', "dozer-icon");}
                    else {newVehiclePin.addProperty('image', "truck-icon");}
                newVehiclePin.addProperty('name', vehicleJson.EquipmentID);
                vehicles[vehicleJson.EquipmentID] = newVehiclePin;
                datasource.add(Object.values(vehicles));
            }

             //Logging:
             //console.log(vehicleJson);
             console.log(datasource);
             console.log(vehicleJson.VehicleType);
            // console.log(newVehiclePin)
        }



        function GetConnectionInfo() {
            return axios.get(baseurl + '/api/signalrnegociate') //?code=7gtVUWFtQhZKqnoMN0WIynAptzk1k0xAS1mfCFE1zuI=') //authentication removed
                .then(function (response) {
                    return response.data
                }).catch(console.error)
        }


        function StartConnection(connection) {
            console.log('connecting...')
            connection.start()
                .then(function () { console.log('connected!') })
                .catch(function (err) {
                    console.error(err)
                    setTimeout(function () { StartConnection(connection) }, 2000)
                })
        }
            

        function closePopup() {
            popup.close();
        }
        
        

    </script>

    <style>
        html,
        body {
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
        }

        #myMap {
            width: 100%;
            height: 100%;
        }
    </style>
</head>

<body onload="GetMap()">
    <div id="myMap"></div>

    <div style="position:absolute;top:10px;left:10px;padding:10px;background-color:white;border-radius:10px;">
        <input type="button" value="Water Hazards On" onclick="showWater('on');" />
        <input type="button" value="Water Hazards Off" onclick="showWater('off');" />
    </div>
    
</body>

</html>