# Realtime Vehicle Tracking Solution Deployment Guide
This guide can be used to manually deploy the solution within your own environment.

<img src=https://github.com/tbecks/Realtime-Vehicle-Tracking/blob/main/docs/img/Realtime%20Vehicle%20Tracking%20Lab%20Architecture.png>

1. [Prerequisites to deploy the solution](#prerequisites-to-deploy-the-solution)
2. Setup IoT Hub for Data Publishing

## Prerequisites to deploy the solution
* Azure account with subscription
* Create an Azure Resource Group called **RealtimeVehicleTracking**
* Install VS Code or Azure CLI

## IoT Hub Configuration
--<img src=https://github.com/tbecks/Realtime-Vehicle-Tracking/blob/main/docs/img/Logo-IoTHub.jpg width=100>

### Setup IoT Hub for Data Publishing
The first step is to setup the IoT Hub to receive messages from the vehicles. Create a simple B1: Basic Tier IoT Hub, with a Public endpoint and a unique name.

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<img src=https://github.com/tbecks/Realtime-Vehicle-Tracking/blob/main/docs/img/Deploy-IoTHub.png width=600>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<img src=https://github.com/tbecks/Realtime-Vehicle-Tracking/blob/main/docs/img/Deploy-IoTHub2.png width=600>
  
Once the IoT Hub is provisioned, go in and create a new device for data capture:
  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<img src=https://github.com/tbecks/Realtime-Vehicle-Tracking/blob/main/docs/img/Deploy-IoTHub3-NewDevice.png width=600>
  
Create a device called **MineVehicle**:
  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<img src=https://github.com/tbecks/Realtime-Vehicle-Tracking/blob/main/docs/img/Deploy-IoTHub4-CreateDevice.png width=600>
  
Click Refresh to see the newly created device.  

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<img src=https://github.com/tbecks/Realtime-Vehicle-Tracking/blob/main/docs/img/Deploy-IoTHub5-Device.png width=600>

This device will be the intended recipient of the vehicle telemetry events.  Even though our payload will be sending events from multiple vehicles, we can have a single device configured in IoT Hub to act as the recipient device.  The next step will be to get a SAS token that the data producer will use to connect to the IoT Hub and send events.

### Generate IoT Hub SAS Token
A Shared Access Signature (SAS) token will be required to enable our event generator to send events to the IoT Hub.  The SAS token can be generated by one of the following ways:

1. VS Code using the [Azure IoT Hub Extension](https://marketplace.visualstudio.com/items?itemName=vsciot-vscode.azure-iot-toolkit)
2. [Azure CLI](https://docs.microsoft.com/en-us/cli/azure/iot/hub?view=azure-cli-latest#az_iot_hub_generate_sas_token)

For this lab we will walk through the Azure CLI method.  Start by opening up a command prompt and running `az login`

Once logged in, generate the token by running: `az iot hub generate-sas-token -d {device_id} -n {iothub_name}`

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<img src=https://github.com/tbecks/Realtime-Vehicle-Tracking/blob/main/docs/img/Deploy-IoTHub7-SASToken.png width=600>

You will need to use the returned SAS token and update the Python based producer in the next steps.

## Setup Python Vehicle Data Producer
To simulate vehicle telemetry being sent to IoT Hub, we will use a Python script to send telemetry data that has been stored in a CSV data file.  The data file is located in the data folder of this repo, and will be referenced by the Python script.

### Update the Python Producer with your environment information
Open the **SendVehicleEvents.py** file in VS Code (or any text editor).  This file can be found in the **/src** folder.

In the file look for the section below `# Replace the following variables with your information`.  You will need to update the following variables:
- `sas`
- `iotHub`
- `deviceId`

### Test the Producer
To test that the Python producer is configured to send data to IoT Hub run...... **FINISH THIS**

## SignalR Configuration
<img src=https://github.com/tbecks/Realtime-Vehicle-Tracking/blob/main/docs/img/Logo-SignalR.png width=100>
*Blurb on SignalR*

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<img src=https://github.com/tbecks/Realtime-Vehicle-Tracking/blob/main/docs/img/Deploy-SignalR-1.png width=600>

Keep the default Public endpoint for this lab.  Once provisioned go in to the overview of you SignalR service and make note of the *connection string:* 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<img src=https://github.com/tbecks/Realtime-Vehicle-Tracking/blob/main/docs/img/Deploy-SignalR-2.png width=600>

## Azure Functions Configuration
<img src=https://github.com/tbecks/Realtime-Vehicle-Tracking/blob/main/docs/img/Logo-AzureFunctions.png width=100>
Azure Functions will be used to pull data from IoT Hub, negotiate a connection with the front end application server and push the events to SignalR which will push the data over a web socket to the web appliation.

The function serves two purposes:

1. Request new events from IoT Hub 
2. Negotiate SignalR Connection to Web App 

Start by configuring an Azure Function instance in Azure:

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<img src=https://github.com/tbecks/Realtime-Vehicle-Tracking/blob/main/docs/img/Deploy-AzureFunction-1.png width=600>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<img src=https://github.com/tbecks/Realtime-Vehicle-Tracking/blob/main/docs/img/Deploy-AzureFunction-2.png width=600>

There is no requirement to have Application Insight Enabled.

Once provisioned, we need to deploy the provided code to the Azure Function service to create the new functions.  Download the #Azure Function source code# and open the VehicleHubPull folder in VS Code:

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<img src=https://github.com/tbecks/Realtime-Vehicle-Tracking/blob/main/docs/img/Deploy-AzureFunction-3.png width=600>

Update the `local.settings.json` file with your environment values:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<img src=https://github.com/tbecks/Realtime-Vehicle-Tracking/blob/main/docs/img/Deploy-AzureFunction-4.png width=600>

  |Configuration Parameter|Where to Get Value|
  |---|---|
  |AzureWebJobsStorage|(insert link)|
  |AzureIOTHubConnectionString|(insert link)|
  |AzureSignalRConnectionString|(insert link)|
  
`Build` and `Deploy` the project to the Azure Functions service.  From the VS Code terminal window run `dotnet build` (or right click the project file and select **Build .NET Core project**).  Once build deploy the solution in VS Code by running the following commands:

- Open the Command Pallette (Ctl-Shift-P)
- Type `Azure Functions: Deploy to function app`
- Walk through the prompts to deploy to the Azure Functions service you deployed previously

Ensure the funciton successfully deploys.

## Azure App Service
The App Service will provide the web based front end.  Create a App Service instance in the Azure Portal:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<img src=https://github.com/tbecks/Realtime-Vehicle-Tracking/blob/main/docs/img/Deploy-AppService-1.png width=600>

The name needs to be unique and will form your sites URL.  Select PHP as the runtime stack as we are using a simple HTML page with Javascript.  Make note of the App Service URL, this will be used to access the web front end from a browser.

Open VS Code and ensure you have the Azure App Service extension installed:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<img src=https://github.com/tbecks/Realtime-Vehicle-Tracking/blob/main/docs/img/Deploy-AppService-3.png width=600>

Then Open the Azure blade and navigate to the Azure App Service section to deploy the web source code to the App Service in Azure:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<img src=https://github.com/tbecks/Realtime-Vehicle-Tracking/blob/main/docs/img/Deploy-AppService-2.png width=600>

This will open the command pallet at the top, follow the steps to choose which folder to deploy to your App Service:
- Navigate to the web folder of the solution repo
- settings:
-   configure > web sockets on?


## Azure Maps Deployment

